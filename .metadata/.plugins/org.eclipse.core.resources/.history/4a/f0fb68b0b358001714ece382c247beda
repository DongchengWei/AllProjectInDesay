/**
 * @Author：Tonsen
 * @Email ：Dongcheng.Wei@desay-svautomotive.com
 * @Date  ：2017-06-22
 */
package com.reboot;

import java.io.File;
import java.io.IOException;

import com.utils.PropUtil;
import com.utils.SerialPortUtil;

/**
 * @author uidq0460
 *
 */
public class Wait {

	public static String propFilePath = "";
	public static String comSaveStr = "";
	public static boolean isRebootOk = false;
	
	/**
	 * 
	 * @param args
	 * @Date 2017-06-22
	 */
	public static void main(String[] args) {
		// TODO Auto-generated method stub
		initUi();
		SerialPortUtil portUtil = new SerialPortUtil();
		comSaveStr = PropUtil.getValueOfProp("comSaveStr", propFilePath);
		System.out.println("Selectet:" + comSaveStr);
		SerialPortUtil.selectPort(comSaveStr);
		portUtil.startRead(0);//监听端口,接收串口的数据
		try {
//			System.out.println("Excu su");
//			portUtil.write("su\r\n");
//			Thread.sleep(200);
//						
//			System.out.println("Excu reboot");
//			portUtil.write("reboot\r\n");
			int waitTime = 1*60*15;
			
			int timeCounter = 0;
			while(timeCounter < waitTime) {
				timeCounter ++;
				Thread.sleep(1000);
				if (isRebootOk == true) {
					if (timeCounter) {
						
					}
					timeCounter = 0;
					portUtil.close();
				}
			}
			if (isRebootOk == false) {
				System.out.println("reboot timeout in 10min");
				portUtil.close();
				System.exit(-1);
			}
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}
	
	/**
	 * 读取配置文件，通过配置文件保存的信息初始化界面
	 * @Date 2017-05-31
	 */
	public static void initUi() {
		String rootDir = System.getProperty("user.dir");
		System.out.println(rootDir);//user.dir指定了当前的路径
		File propDir = new File(rootDir);// + "\\power.properties"
		if (propDir.exists()) {//目录存在
			File propFile = new File(rootDir + "\\Start_adb.properties");
			if (propFile.exists()) {//文件存在
				propFilePath = propFile.getAbsolutePath();
				System.out.println("propFile = exists");
			} else {
				System.out.println("propFile = not exists");
				try {
					if (propFile.createNewFile()) {
						propFilePath = propFile.getAbsolutePath();
						System.out.println("创建成功");
					} else {
						System.out.println("创建失败");
					}
				} catch (IOException e1) {
					e1.printStackTrace();
				}
			}
		}
		if (propFilePath != "") {
			comSaveStr = PropUtil.getValueOfProp("comSaveStr", propFilePath);
			if (comSaveStr.equals("") || comSaveStr == null) {
				System.out.println("COM is not set,try set COM4 ...");
				PropUtil.setProperties(propFilePath, "comSaveStr", "COM4", false);
			}
		}
	}

}
